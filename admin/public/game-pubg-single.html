<html>

<head>
    {{{head}}}
    <style>
        .weapon-row {
            width: 100%;
            padding: 5px 0;
            border-bottom: 1px solid #aaa;
        }

        .weapon-row:hove {
            background-color: #a0a0a0;
        }
    </style>
</head>

<body>
    {{{actionbar}}}
    <div class="container">
        <h2>Game {{{_id}}}:<a href="/admin/games/{{{_id}}}/delete/" class="btn btn-md btn-danger"
                style="float:right;margin-top:5px;">Delete</a></h2>
        <hr />
        <form id="single" action="/admin/games/{{{_id}}}/edit" method="POST"></form>
        <div id="extra"></div>
        <div id="weapons-screen"
            style="display:none;position:fixed;width:100vw;height:100vh;background-color:rgba(0, 0, 0, 0.4);z-index:10000;top:0;left:0">
            <div class="container" style="padding-top:50px;">
                <div class="btn btn-md btn-primary" onclick="weapons_screen_hide()">Close</div>
                <div
                    style="width:100%;height:60vh;background-color:white;padding:10px 20px;margin-top:10px;overflow-y: scroll;">
                    <h3 name="title">Title come Here!</h3>
                    <div name="list">

                    </div>
                </div>
            </div>
        </div>
        <script>
            let game = null;
            const FILE_UPLOAD_URL = `{{{fileUploadURL}}}?my-dir=games`;
            let MY_DIR = ``;
            $(document).ready(() =>
            {
                getObject('games', `{{{_id}}}`, (g) =>
                {
                    if (g.twitchGameId == undefined)
                        g.twitchGameId = '';
                    game = g;
                    if (game.maps == undefined)
                        game.maps = [];
                    if (game.consumables == undefined)
                        game.consumables = [];
                    if (game.equipments == undefined)
                        game.equipments = [];
                    if (game.ammunations == undefined)
                        game.ammunations = [];
                    if (game.attachmentCategories == undefined)
                        game.attachmentCategories = [];
                    if (game.attachments == undefined)
                        game.attachments = [];
                    if (game.weaponCategories == undefined)
                        game.weaponCategories = [];
                    if (game.weapons == undefined)
                        game.weapons = [];
                    console.log(game);
                    MY_DIR = `games/${game.token}`;
                    $("#single").append(idInput('_id', game._id));
                    $("#single").append(draftInput(game._draft));
                    $("#single").append(idInput('createdAt', game.createdAt));
                    $("#single").append(idInput('updatedAt', game.updatedAt));
                    $("#single").append(textInput('name', game.name));
                    $("#single").append(textInput('token', game.token));
                    $("#single").append(textInput('slug', game.slug));
                    $("#single").append(textInput('category', game.category));
                    $("#single").append(textInput('ageRange', game.ageRange));
                    $("#single").append(textInput('twitchGameId', game.twitchGameId));
                    $("#single").append(bodyInput('description', game.description));
                    imageInput('#single', 'icon', game.icon, FILE_UPLOAD_URL, MY_DIR);
                    imageInput('#single', 'cover', game.cover, FILE_UPLOAD_URL, MY_DIR);
                    imageInput('#single', 'coverTall', game.coverTall, FILE_UPLOAD_URL, MY_DIR);
                    $("#single").append(submitBtn());
                    $("#single").append(`<input type="submit" value="Save" class="btn btn-md btn-success" style="position:fixed;bottom:10px;right:10px;"/>`)

                    //extra fields
                    $("#single").append(jsonInput('maps', game.maps));
                    $("#single").append(jsonInput('consumables', game.consumables));
                    $("#single").append(jsonInput('equipments', game.equipments));
                    $("#single").append(jsonInput('ammunations', game.ammunations));
                    $("#single").append(jsonInput('attachmentCategories', game.attachmentCategories));
                    $("#single").append(jsonInput('attachments', game.attachments));
                    $("#single").append(jsonInput('weaponCategories', game.weaponCategories));
                    $("#single").append(jsonInput('weapons', game.weapons));
                    //extras setup:
                    $("#extra").append(`<div id="maps"></div>`);
                    maps_recreate();
                    $("#extra").append(`<div id="consumables"></div>`);
                    consumables_recreate();
                    $("#extra").append(`<div id="equipments"></div>`);
                    equipments_recreate();
                    $("#extra").append(`<div id="ammunations"></div>`);
                    ammunations_recreate();
                    $("#extra").append(`<div id="attachmentCategories"></div>`);
                    attachmentCategories_recreate();
                    $("#extra").append(`<div id="attachments"></div>`);
                    attachments_recreate();
                    $("#extra").append(`<div id="weaponCategories"></div>`);
                    weaponCategories_recreate();
                    $("#extra").append(`<div id="weapons"></div>`);
                    weapons_recreate();
                });
            });
            function maps_recreate()
            {
                $("[name=maps]").val(JSON.stringify(game.maps));
                $("#maps").html(`<h3>Maps:</h3><div class="btn btn-md btn-secondary" onclick="maps_add()">+Add Map</div>`)
                for (var i = 0; i < game.maps.length; i++)
                {
                    var map = game.maps[i];
                    $("#maps").append(`
                    <div class="box-row map-box-container" id="maps-wrapper-${map._id}" mapId="${map._id}" index="${i}">
                        <img name="preview-icon" src="${map.icon}" width="128px" height="128px"/>
                        &nbsp;<b name="preview-name">${map.name}</b>
                        <div class="btn btn-md btn-info" onclick="maps_toggle('${map._id}')">Expand</div>
                        <div class="map-box" style="display:none" id="maps-${map._id}" mapId="${map._id}" index="${i}">
                        </div>
                    </div>
                    `);
                    $(`#maps-${map._id}`).append(idInput('_id', map._id));
                    $(`#maps-${map._id}`).append(textInput('name', map.name));
                    $(`#maps-${map._id}`).append(textInput('slug', map.slug));
                    $(`#maps-${map._id}`).append(textInput('subtitle', map.subtitle));
                    $(`#maps-${map._id}`).append(InputUtils.airInput('description', map.description));
                    $(`#maps-${map._id}`).append(filePickTool(undefined, 'thumbnail', map.thumbnail));
                    $(`#maps-${map._id}`).append(filePickTool(undefined, 'cover', map.cover));
                    $(`#maps-${map._id}`).append(jsonInput('weapons', map.weapons));
                    $(`#maps-${map._id}`).append(`<div name="weapons-container"><h5>Available Weapons:</h5><div class="btn btn-xs btn-secondary">+Add Weapon</div></div>`);
                    for (var j = 0; j < map.weapons.length; j++)
                    {
                        var weapon = get_weapon(map.weapons[j]);
                        if (weapon == undefined)
                            continue;
                        $(`#maps-${map._id} [name=weapons-container]`).append(`
                            <div style="padding:10px 20px;border-bottom:1px solid #ccc;">
                                <b>${weapon._id}</b>&nbsp;&nbsp;&nbsp;
                                <span>${weapon.name}</span>
                                <div class="btn btn-xs btn-info" onclick="maps_weapon_move(${i},${j},-1)">Up</div>
                                <div class="btn btn-xs btn-info" onclick="maps_weapon_move(${i},${j},1)">Down</div>
                                <div class="btn btn-xs btn-danger" onclick="maps_weapon_remove(${i},${j})">Remove</div>
                            </div>
                        `);
                    }

                    $(`#maps-${map._id}`).append(`<div class="btn btn-md btn-danger" onclick="maps_remove(${i})">Remove</div>`);
                }
                $("#maps input,#maps textarea").on('change', function ()
                {
                    maps_update(this);
                });
            }
            function maps_add()
            {
                game.maps.push({
                    _id: InputUtils.ID(),
                    name: 'New Map',
                    slug: '',
                    subtitle: 'N x N 64KM',
                    description: '',
                    thumbnail: '',
                    cover: '',
                    weapons: [],
                });
                maps_recreate();
            }
            function maps_toggle(_id)
            {
                $(`#maps-${_id}`).toggle();
            }
            function maps_remove(index)
            {
                game.maps.splice(index, 1);
                maps_recreate();
            }
            function maps_update(elm)
            {
                var i = $(elm).closest(".map-box").attr("index");
                var map = game.maps[i];
                const _id = map._id;
                game.maps[i] = {
                    _id: $(`#maps-${_id} [name=_id]`).val(),
                    name: $(`#maps-${_id} [name=name]`).val(),
                    slug: $(`#maps-${_id} [name=slug]`).val(),
                    subtitle: $(`#maps-${_id} [name=subtitle]`).val(),
                    description: $(`#maps-${_id} [name=description]`).val(),
                    thumbnail: $(`#maps-${_id} [name=thumbnail]`).val(),
                    cover: $(`#maps-${_id} [name=cover]`).val(),
                    weapons: JSON.parse($(`#maps-${_id} [name=weapons]`).val()),
                };
                $("[name=maps]").val(JSON.stringify(game.maps));
                $(`#maps-wrapper-${_id} [name=preview-name]`).html(map.name);
                $(`#maps-wrapper-${_id} [name=preview-icon]`).attr('src', map.thumbnail);
            }
            function maps_weapon_move(mIndex, wIndex, dir)
            {
                if ((wIndex == 0 && dir == -1) || (wIndex == game.maps[mIndex].weapons.length - 1 && dir == 1))
                {
                    alert('action not allowed!');
                    return;
                }
                var map = game.maps[mIndex];
                var temp = map.weapons[wIndex];
                map.weapons[wIndex] = map.weapons[wIndex + dir];
                map.weapons[wIndex + dir] = temp;
                maps_recreate();
                maps_toggle(map._id);
            }
            function maps_weapon_remove(mIndex, wIndex)
            {
                game.maps[mIndex].weapons.splice(wIndex, 1);
                maps_recreate();
                maps_toggle(map._id);
            }
            function consumables_recreate()
            {
                $("[name=consumables]").val(JSON.stringify(game.consumables));
                $("#consumables").html(`<h3>consumables:</h3><div class="btn btn-md btn-secondary" onclick="consumables_add()">+Add consumable</div>`)
                for (var i = 0; i < game.consumables.length; i++)
                {
                    var c = game.consumables[i];
                    $("#consumables").append(`
                    <div class="box-row consumable-box-container" id="consumables-wrapper-${c._id}" mapId="${c._id}" index="${i}">
                        <img name="preview-icon" src="${c.icon}" width="128px" height="128px"/>
                        &nbsp;<b name="preview-name">${c.name}</b>
                        <div class="btn btn-md btn-info" onclick="consumables_toggle('${c._id}')">Expand</div>
                        <div class="consumable-box" style="display:none" id="consumables-${c._id}" consumableId="${c._id}" index="${i}">
                        </div>
                    </div>
                    `);
                    $(`#consumables-${c._id}`).append(idInput('_id', c._id));
                    $(`#consumables-${c._id}`).append(textInput('name', c.name));
                    $(`#consumables-${c._id}`).append(textInput('slug', c.slug));
                    $(`#consumables-${c._id}`).append(InputUtils.airInput('description', c.description));
                    $(`#consumables-${c._id}`).append(filePickTool(undefined, 'icon', c.icon));
                    $(`#consumables-${c._id}`).append(`<div class="btn btn-md btn-danger" onclick="consumables_remove(${i})">Remove</div>`);
                }
                $("#consumables input,#consumables textarea").on('change', function ()
                {
                    consumables_update(this);
                });
            }
            function consumables_add()
            {
                game.consumables.push({
                    _id: InputUtils.ID(),
                    name: 'New Consumable',
                    slug: '',
                    description: '',
                    icon: '',
                });
                consumables_recreate();
            }
            function consumables_remove(index)
            {
                game.consumables.splice(index, 1);
                consumables_recreate();
            }
            function consumables_toggle(i)
            {
                $(`#consumables-${i}`).toggle();
            }
            function consumables_update(elm)
            {
                var i = $(elm).closest(".consumable-box").attr('index');
                var _id = game.consumables[i]._id;
                game.consumables[i] = {
                    _id: $(`#consumables-${_id} [name=_id]`).val(),
                    name: $(`#consumables-${_id} [name=name]`).val(),
                    slug: $(`#consumables-${_id} [name=slug]`).val(),
                    description: $(`#consumables-${_id} [name=description]`).val(),
                    icon: $(`#consumables-${_id} [name=icon]`).val(),
                };
                $("[name=consumables]").val(JSON.stringify(game.consumables));
                $(`#consumables-wrapper-${_id} [name=preview-name]`).html(game.consumables[i].name);
                $(`#consumables-wrapper-${_id} [name=preview-icon]`).attr('src', game.consumables[i].icon);
            }
            function equipments_recreate()
            {
                $("[name=equipments]").val(JSON.stringify(game.equipments));
                $("#equipments").html(`<h3>equipments:</h3><div class="btn btn-md btn-secondary" onclick="equipments_add()">+Add equipment</div>`)
                for (var i = 0; i < game.equipments.length; i++)
                {
                    var e = game.equipments[i];
                    $("#equipments").append(`
                    <div class="box-row equipment-box-container" id="equipments-wrapper-${e._id}" equipmentId="${e._id}" index="${i}">
                        <img name="preview-icon" src="${e.icon}" width="128px" height="128px"/>
                        &nbsp;<b name="preview-name">${e.name}</b>
                        <div class="btn btn-md btn-info" onclick="equipments_toggle('${e._id}')">Expand</div>
                        <div class="equipment-box" style="display:none" id="equipments-${e._id}" equipmentId="${e._id}" index="${i}">
                        </div>
                    </div>
                    `);
                    $(`#equipments-${e._id}`).append(idInput('_id', e._id));
                    $(`#equipments-${e._id}`).append(textInput('name', e.name));
                    $(`#equipments-${e._id}`).append(textInput('slug', e.slug));
                    $(`#equipments-${e._id}`).append(textInput('category', e.category));
                    $(`#equipments-${e._id}`).append(InputUtils.airInput('description', e.description));
                    $(`#equipments-${e._id}`).append(filePickTool(undefined, 'icon', e.icon));
                    $(`#equipments-${e._id}`).append(`<div class="btn btn-md btn-danger" onclick="equipments_remove(${i})">Remove</div>`);
                }
                $("#equipments input,#equipments textarea").on('change', function ()
                {
                    equipments_update(this);
                });
            }
            function equipments_add()
            {
                game.equipments.push({
                    _id: InputUtils.ID(),
                    name: 'New EQ',
                    slug: '',
                    category: '',
                    description: '',
                    icon: ''
                });
                equipments_recreate();
            }
            function equipments_remove(index)
            {
                game.equipments.splice(index, 1);
                equipments_recreate();
            }
            function equipments_toggle(_id)
            {
                $(`#equipments-${_id}`).toggle();
            }
            function equipments_update(elm)
            {
                var i = $(elm).closest(".equipment-box").attr('index');
                var _id = game.equipments[i]._id;
                game.equipments[i] = {
                    _id: $(`#equipments-${_id} [name=_id]`).val(),
                    name: $(`#equipments-${_id} [name=name]`).val(),
                    slug: $(`#equipments-${_id} [name=slug]`).val(),
                    category: $(`#equipments-${_id} [name=category]`).val(),
                    description: $(`#equipments-${_id} [name=description]`).val(),
                    icon: $(`#equipments-${_id} [name=icon]`).val(),
                };
                $("[name=equipments]").val(JSON.stringify(game.equipments));
                $(`#equipments-wrapper-${_id} [name=preview-name]`).html(game.equipments[i].name);
                $(`#equipments-wrapper-${_id} [name=preview-icon]`).attr('src', game.equipments[i].icon);
            }
            function ammunations_recreate()
            {
                $("[name=ammunations]").val(JSON.stringify(game.ammunations));
                $("#ammunations").html(`<h3>ammunations:</h3><div class="btn btn-md btn-secondary" onclick="ammunations_add()">+Add ammunation</div>`)
                for (var i = 0; i < game.ammunations.length; i++)
                {
                    var a = game.ammunations[i];
                    $("#ammunations").append(`
                    <div class="box-row ammunation-box-container" id="ammunations-wrapper-${a._id}" ammunationId="${a._id}" index="${i}">
                        <img name="preview-icon" src="${a.icon}" width="128px" height="128px"/>
                        &nbsp;<b name="preview-name">${a.name}</b>
                        <div class="btn btn-md btn-info" onclick="ammunations_toggle('${a._id}')">Expand</div>
                        <div class="ammunation-box" style="display:none" id="ammunations-${a._id}" ammunationId="${a._id}" index="${i}">
                        </div>
                    </div>
                    `);
                    $(`#ammunations-${a._id}`).append(idInput('_id', a._id));
                    $(`#ammunations-${a._id}`).append(textInput('name', a.name));
                    $(`#ammunations-${a._id}`).append(textInput('slug', a.slug));
                    $(`#ammunations-${a._id}`).append(InputUtils.airInput('description', a.description));
                    $(`#ammunations-${a._id}`).append(filePickTool(undefined, 'icon', a.icon));
                    $(`#ammunations-${a._id}`).append(jsonInput('weapons', a.weapons));
                    //TODO: weapons screen
                    $(`#ammunations-${a._id}`).append(`<div class="btn btn-md btn-danger" onclick="ammunations_remove(${i})">Remove</div>`);
                }
                $("#ammunations input,#ammunations textarea").on('change', function ()
                {
                    ammunations_update(this);
                });
            }
            function ammunations_add()
            {
                game.ammunations.push({
                    _id: InputUtils.ID(),
                    name: 'AMMU 1',
                    slug: '',
                    description: '',
                    icon: '',
                    weapons: [],
                });
                ammunations_recreate();
            }
            function ammunations_remove(index)
            {
                game.ammunations.splice(index, 1);
                ammunations_recreate();
            }
            function ammunations_toggle(_id)
            {
                $(`#ammunations-${_id}`).toggle();
            }
            function ammunations_update(elm)
            {
                var i = $(elm).closest(".ammunation-box").attr('index');
                var _id = game.ammunations[i]._id;
                game.ammunations[i] = {
                    _id: $(`#ammunations-${_id} [name=_id]`).val(),
                    name: $(`#ammunations-${_id} [name=name]`).val(),
                    slug: $(`#ammunations-${_id} [name=slug]`).val(),
                    description: $(`#ammunations-${_id} [name=description]`).val(),
                    icon: $(`#ammunations-${_id} [name=icon]`).val(),
                    weapons: JSON.parse($(`#ammunations-${_id} [name=weapons]`).val()),
                };
                $("[name=ammunations]").val(JSON.stringify(game.ammunations));
                $(`#ammunations-wrapper-${_id} [name=preview-name]`).html(game.ammunations[i].name);
                $(`#ammunations-wrapper-${_id} [name=preview-icon]`).attr('src', game.ammunations[i].icon);
            }
            function attachmentCategories_recreate()
            {
                $("[name=attachmentCategories]").val(JSON.stringify(game.attachmentCategories));
                $("#attachmentCategories").html(`<h3>attachmentCategories:</h3><div class="btn btn-md btn-secondary" onclick="attachmentCategories_add()">+Add attachmentCategory</div>`)
                for (var i = 0; i < game.attachmentCategories.length; i++)
                {
                    var cat = game.attachmentCategories[i];
                    $("#attachmentCategories").append(`
                    <div class="box-row attachmentCategory-box-container" id="attachmentCategories-wrapper-${cat._id}" attachmentCategoryId="${cat._id}" index="${i}">
                        <b name="preview-name">${cat.name}</b>
                        <div class="btn btn-md btn-info" onclick="attachmentCategories_toggle('${cat._id}')">Expand</div>
                        <div class="attachmentCategory-box" style="display:none" id="attachmentCategories-${cat._id}" attachmentCategoriesId="${cat._id}" index="${i}">
                        </div>
                    </div>
                    `);
                    $(`#attachmentCategories-${cat._id}`).append(idInput('_id', cat._id));
                    $(`#attachmentCategories-${cat._id}`).append(textInput('name', cat.name));
                    $(`#attachmentCategories-${cat._id}`).append(textInput('slug', cat.slug));
                    $(`#attachmentCategories-${cat._id}`).append(`<div class="btn btn-md btn-danger" onclick="attachmentCategories_remove(${i})">Remove</div>`);
                }
                $("#attachmentCategories input,#attachmentCategories textarea").on('change', function ()
                {
                    attachmentCategories_update(this);
                });
            }
            function attachmentCategories_add()
            {
                game.attachmentCategories.push({
                    _id: InputUtils.ID(),
                    name: 'Cat 1',
                    slug: '',
                });
                attachmentCategories_recreate();
            }
            function attachmentCategories_remove(index)
            {
                game.attachmentCategories.splice(index, 1);
                attachmentCategories_recreate();
            }
            function attachmentCategories_toggle(_id)
            {
                $(`#attachmentCategories-${_id}`).toggle();
            }
            function attachmentCategories_update(elm)
            {
                var i = $(elm).closest(".attachmentCategory-box").attr('index');
                var _id = game.attachmentCategories[i]._id;
                game.attachmentCategories[i] = {
                    _id: $(`#attachmentCategories-${_id} [name=_id]`).val(),
                    name: $(`#attachmentCategories-${_id} [name=name]`).val(),
                    slug: $(`#attachmentCategories-${_id} [name=slug]`).val(),
                };
                $("[name=attachmentCategories]").val(JSON.stringify(game.attachmentCategories));
                $(`#attachmentCategories-wrapper-${_id} [name=preview-name]`).html(game.attachmentCategories[i].name);
            }
            function attachments_recreate()
            {
                $("[name=attachments]").val(JSON.stringify(game.attachments));
                $("#attachments").html(`<h3>attachments:</h3><div class="btn btn-md btn-secondary" onclick="attachments_add()">+Add attachment</div>`)
                for (var i = 0; i < game.attachments.length; i++)
                {
                    var a = game.attachments[i];
                    $("#attachments").append(`
                    <div class="box-row attachment-box-container" id="attachments-wrapper-${a._id}" attachmentId="${a._id}" index="${i}">
                        <img name="preview-icon" src="${a.icon}" width="128px" height="128px"/>
                        &nbsp;<b name="preview-name">${a.name}</b>
                        <div class="btn btn-md btn-info" onclick="attachments_toggle('${a._id}')">Expand</div>
                        <div class="attachment-box" style="display:none" id="attachments-${a._id}" attachmentId="${a._id}" index="${i}">
                        </div>
                    </div>
                    `);
                    $(`#attachments-${a._id}`).append(idInput('_id', a._id));
                    $(`#attachments-${a._id}`).append(textInput('name', a.name));
                    $(`#attachments-${a._id}`).append(textInput('slug', a.slug));
                    $(`#attachments-${a._id}`).append(InputUtils.textInput('category', a.category, { after: 'Enter _id of attachmentCategory here!' }));
                    $(`#attachments-${a._id}`).append(InputUtils.textInput('weaponType', a.weaponType, { after: 'gun/bow/grenade/melee' }));
                    $(`#attachments-${a._id}`).append(InputUtils.airInput('description', a.description));
                    $(`#attachments-${a._id}`).append(filePickTool(undefined, 'icon', a.icon));
                    $(`#attachments-${a._id}`).append(jsonInput('attachesTo', a.attachesTo));
                    //TODO: weapons screen
                    $(`#attachments-${a._id}`).append(`<div class="btn btn-md btn-danger" onclick="attachments_remove(${i})">Remove</div>`);
                }
                $("#attachments input,#attachments textarea").on('change', function ()
                {
                    attachments_update(this);
                });
            }
            function attachments_add()
            {
                game.attachments.push({
                    _id: InputUtils.ID(),
                    name: 'AMMU 1',
                    slug: '',
                    description: '',
                    icon: '',
                    category: '',
                    weaponType: '',
                    attachesTo: [],
                });
                attachments_recreate();
            }
            function attachments_remove(index)
            {
                game.attachments.splice(index, 1);
                attachments_recreate();
            }
            function attachments_toggle(_id)
            {
                $(`#attachments-${_id}`).toggle();
            }
            function attachments_update(elm)
            {
                var i = $(elm).closest(".attachment-box").attr('index');
                var _id = game.attachments[i]._id;
                game.attachments[i] = {
                    _id: $(`#attachments-${_id} [name=_id]`).val(),
                    name: $(`#attachments-${_id} [name=name]`).val(),
                    slug: $(`#attachments-${_id} [name=slug]`).val(),
                    category: $(`#attachments-${_id} [name=category]`).val(),
                    weaponType: $(`#attachments-${_id} [name=weaponType]`).val(),
                    description: $(`#attachments-${_id} [name=description]`).val(),
                    icon: $(`#attachments-${_id} [name=icon]`).val(),
                    attachesTo: JSON.parse($(`#attachments-${_id} [name=attachesTo]`).val()),
                };
                $("[name=attachments]").val(JSON.stringify(game.attachments));
                $(`#attachments-wrapper-${_id} [name=preview-name]`).html(game.attachments[i].name);
                $(`#attachments-wrapper-${_id} [name=preview-icon]`).attr('src', game.attachments[i].icon);
            }
            function weaponCategories_recreate()
            {
                $("[name=weaponCategories]").val(JSON.stringify(game.weaponCategories));
                $("#weaponCategories").html(`<h3>weaponCategories:</h3><div class="btn btn-md btn-secondary" onclick="weaponCategories_add()">+Add weaponCategory</div>`)
                for (var i = 0; i < game.weaponCategories.length; i++)
                {
                    var cat = game.weaponCategories[i];
                    $("#weaponCategories").append(`
                    <div class="box-row weaponCategory-box-container" id="weaponCategories-wrapper-${cat._id}" weaponCategoryId="${cat._id}" index="${i}">
                        <b name="preview-name">${cat.name}</b>
                        <div class="btn btn-md btn-info" onclick="weaponCategories_toggle('${cat._id}')">Expand</div>
                        <div class="weaponCategory-box" style="display:none" id="weaponCategories-${cat._id}" weaponCategoriesId="${cat._id}" index="${i}">
                        </div>
                    </div>
                    `);
                    $(`#weaponCategories-${cat._id}`).append(idInput('_id', cat._id));
                    $(`#weaponCategories-${cat._id}`).append(textInput('name', cat.name));
                    $(`#weaponCategories-${cat._id}`).append(textInput('slug', cat.slug));
                    $(`#weaponCategories-${cat._id}`).append(`<div class="btn btn-md btn-danger" onclick="weaponCategories_remove(${i})">Remove</div>`);
                }
                $("#weaponCategories input,#weaponCategories textarea").on('change', function ()
                {
                    weaponCategories_update(this);
                });
            }
            function weaponCategories_add()
            {
                game.weaponCategories.push({
                    _id: InputUtils.ID(),
                    name: 'Cat 1',
                    slug: '',
                });
                weaponCategories_recreate();
            }
            function weaponCategories_remove(index)
            {
                game.weaponCategories.splice(index, 1);
                weaponCategories_recreate();
            }
            function weaponCategories_toggle(_id)
            {
                $(`#weaponCategories-${_id}`).toggle();
            }
            function weaponCategories_update(elm)
            {
                var i = $(elm).closest(".weaponCategory-box").attr('index');
                var _id = game.weaponCategories[i]._id;
                game.weaponCategories[i] = {
                    _id: $(`#weaponCategories-${_id} [name=_id]`).val(),
                    name: $(`#weaponCategories-${_id} [name=name]`).val(),
                    slug: $(`#weaponCategories-${_id} [name=slug]`).val(),
                };
                $("[name=weaponCategories]").val(JSON.stringify(game.weaponCategories));
                $(`#weaponCategories-wrapper-${_id} [name=preview-name]`).html(game.weaponCategories[i].name);
            }
            function get_weapon(_id)
            {
                for (var i = 0; i < game.weapons.length; i++)
                    if (game.weapons[i]._id == _id)
                        return game.weapons[i];
                return undefined;
            }
            function weapons_recreate()
            {
                $("[name=weapons]").val(JSON.stringify(game.weapons));
                $("#weapons").html(`<h3>weapons:</h3><div class="btn btn-md btn-secondary" onclick="weapons_add()">+Add weapon</div>`);
                weapons_screen_recreate();
                for (var i = 0; i < game.weapons.length; i++)
                {
                    var a = game.weapons[i];
                    $("#weapons").append(`
                    <div class="box-row weapon-box-container" id="weapons-wrapper-${a._id}" weaponId="${a._id}" index="${i}">
                        <img name="preview-icon" src="${a.icon}" width="128px" height="128px"/>
                        &nbsp;<b name="preview-name">${a.name}</b>
                        <div class="btn btn-md btn-info" onclick="weapons_toggle('${a._id}')">Expand</div>
                        <div class="weapon-box" style="display:none" id="weapons-${a._id}" weaponId="${a._id}" index="${i}">
                        </div>
                    </div>
                    `);
                    $(`#weapons-${a._id}`).append(idInput('_id', a._id));
                    $(`#weapons-${a._id}`).append(textInput('name', a.name));
                    $(`#weapons-${a._id}`).append(textInput('slug', a.slug));
                    $(`#weapons-${a._id}`).append(InputUtils.textInput('category', a.category, { after: 'Enter _id of weaponCategory here!' }));
                    $(`#weapons-${a._id}`).append(InputUtils.textInput('type', a.type, { after: 'bow/gun/melee/grenade' }));
                    $(`#weapons-${a._id}`).append(InputUtils.textInput('range', a.range, { after: '' }));
                    $(`#weapons-${a._id}`).append(InputUtils.airInput('description', a.description));
                    $(`#weapons-${a._id}`).append(filePickTool(undefined, 'icon', a.icon));
                    $(`#weapons-${a._id}`).append(jsonInput('audios', a.audios));
                    $(`#weapons-${a._id}`).append(`<hr><h5>Audios:</h5><div label="audios-container"></div>`);
                    for (var j = 0; j < 4 || j < a.audios.length; j++)
                    {
                        $(`#weapons-${a._id} [label=audios-container]`).append(filePickTool(undefined, `audios-${j}`, a.audios[j] ? a.audios[j] : ''));
                    }
                    //TODO: weapons screen
                    $(`#weapons-${a._id}`).append(`<div class="btn btn-md btn-danger" onclick="weapons_remove(${i})">Remove</div>`);
                }
                $("#weapons input,#weapons textarea").on('change', function ()
                {
                    weapons_update(this);
                });
            }
            function weapons_add()
            {
                game.weapons.push({
                    _id: InputUtils.ID(),
                    icon: '',
                    name: 'Weapon 1',
                    slug: '',
                    description: '',
                    category: '',
                    type: '',
                    range: '',
                    audios: [],
                });
                weapons_recreate();
            }
            function weapons_remove(index)
            {
                game.weapons.splice(index, 1);
                weapons_recreate();
            }
            function weapons_toggle(_id)
            {
                $(`#weapons-${_id}`).toggle();
            }
            function weapons_update(elm)
            {
                var i = $(elm).closest(".weapon-box").attr('index');
                var _id = game.weapons[i]._id;
                var audios = [];
                var audElms = $(`#weapons-${_id} [label=audios-container] input`);
                for (var j = 0; j < audElms.length; j++)
                {
                    var val = $(audElms[j]).val();
                    if (!isEmptyString(val))
                        audios.push(val);
                }
                game.weapons[i] = {
                    _id: $(`#weapons-${_id} [name=_id]`).val(),
                    name: $(`#weapons-${_id} [name=name]`).val(),
                    slug: $(`#weapons-${_id} [name=slug]`).val(),
                    category: $(`#weapons-${_id} [name=category]`).val(),
                    type: $(`#weapons-${_id} [name=type]`).val(),
                    range: $(`#weapons-${_id} [name=range]`).val(),
                    description: $(`#weapons-${_id} [name=description]`).val(),
                    icon: $(`#weapons-${_id} [name=icon]`).val(),
                    audios: audios,
                };
                $("[name=weapons]").val(JSON.stringify(game.weapons));
                $(`#weapons-wrapper-${_id} [name=preview-name]`).html(game.weapons[i].name);
                $(`#weapons-wrapper-${_id} [name=preview-icon]`).attr('src', game.weapons[i].icon);
                weapons_screen_recreate();
            }
            function weapons_screen_recreate()
            {
                $("#weapons-screen [name=list]").html('');
                for (var i = 0; i < game.weapons.length; i++)
                {
                    var w = game.weapons[i];
                    $("#weapons-screen [name=list]").append(`
                        <div class="weapon-row">
                            <img src="${w.icon}" width="64px" height="64px"/>
                            <b>${w.name}</b>
                        </div>
                    `);
                }
            }
            function weapons_screen_hide()
            {
                $("#weapons-screen").hide();
            }
            function weapons_screen_show_for_map(mapId)
            {
                $("#weapons-screen [name=title]").html(`Add Weapon to ${mapId}`);
                $("#weapons-screen").show();
                $(".weapon-row").click(() =>
                {

                });
            }
        </script>
    </div>
    {{{footer}}}
    {{{file_screen}}}
</body>

</html>