<html>

<head>
    {{{head}}}
    <style>
        .richard {
            background-image: url('/images/frejlord.jpg');
            background-position: center;
            background-size: cover;
            background-repeat: no-repeat;
            margin-top: 80px;
            margin-bottom: -20px;
            min-height: 80vh;
        }

        .intro-card {
            margin-top: 50px;
            box-shadow: 5px 10px 10px #a872ffe7;
            border-radius: 10px;
            margin-bottom: 30px
        }

        .intro-body {
            background-color: #0b0119;
            padding: 10px;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px
        }

        .question-card {
            margin-top: 50px;
            box-shadow: 5px 10px 10px #a872ff;
            border-radius: 10px;
            margin-bottom: 30px
        }

        .question-wrapper {
            background-color: #0b0119;
            padding: 10px;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px;
            color: white;

        }

        .loading-card {
            margin-top: 50px;
            box-shadow: 5px 10px 10px #a872ff;
            border-radius: 10px;
            margin-bottom: 30px
        }

        .loading-body {
            background-color: #0b0119;
            padding: 10px;
            border-bottom-left-radius: 10px;
            border-bottom-right-radius: 10px
        }

        .title {
            background-color: #34156b;
            width: 100%;
            font-size: 20px;
            color: white;
            padding: 20px;
            border-top-left-radius: 10px;
            border-top-right-radius: 10px
        }

        .intro-description {
            color: #b685f7;
            font-size: 18px;
            line-height: 26px;
        }

        .description {
            color: #b685f7;
            font-size: 18px;
            line-height: 26px;
        }

        .start-btn {
            display: block;
            margin: 0 auto;
            width: 95%;
            font-size: 20px;
            border-radius: 10px;
            margin-bottom: 50px
        }

        .coin-box {
            background-color: #0b0119;
            width: 100%;
            font-size: 20px;
            color: white;
            padding: 20px;
            box-shadow: 5px 10px 10px #a872ff;
            border-radius: 10px;
            margin-bottom: 50px
        }

        .coin-text {
            color: #b685f7;
        }

        .answer-boxes {
            background-color: #162034;
            width: 45%;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
            border-radius: 5px;
            min-height: 80px;
            cursor: pointer;
        }

        .answer-boxes img {
            width: 128px;
        }

        .question-body img {
            max-width: 256px;
            height: auto;
            margin-bottom: 20px;
            margin-top: 20px
        }

        .question-body2 img {
            max-width: 256px;
            height: auto;
            margin-bottom: 20px;
            margin-top: 20px
        }

        .choosen-answer {
            background-color: grey;
            width: 45%;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
            border-radius: 5px
        }

        .correct-answer {
            background-color: green;
            width: 45%;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
            border-radius: 5px
        }

        .false-answer {
            background-color: red;
            width: 45%;
            display: inline-block;
            margin-right: 10px;
            margin-bottom: 10px;
            border-radius: 5px
        }

        .time-box {
            margin-top: 20px;
        }

        .quiz-side-box {
            background: #0b0119;
            left: 0;
            width: 300px;
            height: 150px;
            position: fixed;
            margin-top: 100px;
            border-top-right-radius: 10px;
            border-bottom-right-radius: 10px;
            box-shadow: 5px 10px 10px #a872ffb7;
        }

        .quiz-side-box-text {
            color: white;
            margin-top: 55px
        }

        .mobile-box {
            display: none
        }

        @media(max-width:576px) {
            .quiz-side-box {
                display: none
            }

            .wrong-answer-error-text {
                font-size: 16px
            }

            .mobile-box {
                display: block;
                background: #0b0119;
                border-radius: 10px;
                box-shadow: 5px 10px 10px #a872ffb7;
                margin-top: 10px;
                height: 100px;
                padding-top: 30px
            }

            .mobile-box-text {
                color: white;
            }
        }
    </style>

</head>

<body>
    {{{navbar}}}
    <div class="quiz-side-box text-center">
        <h2 class="quiz-side-box-text"> آزمون فلان</h2>
    </div>
    <section class="richard">
        <div class="container">
            <div style="padding-top:20px">
                <div class="mobile-box text-center">
                    <h2 class="mobile-box-text"> آزمون فلان</h2>
                </div>
            </div>
            <div id="intro-box">
                <div class="row">
                    <div class="col-md-3"></div>
                    <div class="col-md-6">
                        <div class="intro-card">
                            <div class="title text-center">آزمون روزانه Epic Center</div>
                            <div class="intro-body">
                                <img src="/dota2-quiz/images/rubick.jpg" style="width: 100%;margin-bottom: 10px" alt="">
                                <p class="intro-description">به آزمون روزانه مخصوص مسابقات پیش‌ بینی خوش آمدید! با پاسخ
                                    دادن
                                    به
                                    سوالات این آزمون
                                    میتوانیدسکه کسب کنید تا وقتی که درست جواب بدهید میتوانیدادامه دهید و سکه بیشتری کسب
                                    کنید
                                </p>
                                <div type="button" class="btn btn-success start-btn" onclick="startQuiz()">
                                    شروع</div>
                            </div>
                        </div>
                        <div class="coin-box">
                            <p class="coin-text" style="display: inline">جایزه فعلی شما: </p><i class="fas fa-coins"
                                style="color: gold;padding: 10px ;display: inline;direction:rtl;padding: 10px"></i><span>10</span>
                        </div>
                    </div>
                    <div class="col-md-3"></div>
                </div>
            </div>
            <!-- loadingbox -->
            <div class="row" id="loading-box" style="display:none">
                <div class="col-md-3"></div>
                <div class="col-md-6">
                    <div class="loading-card">
                        <div class="title text-center"></div>
                        <div class="loading-body">
                            <div id="loading" class="text-center">
                                <div class="lds-ellipsis">
                                    <div></div>
                                    <div></div>
                                    <div></div>
                                    <div></div>
                                </div>
                            </div>
                            <div class="text-center text-white" style="direction:ltr;" id="loading-text">Loading..
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- second box -->
            <div style="display: none" id="questions">
                <div class="row" id="question-box">
                    <div class="col-md-3"></div>
                    <div class="col-md-6">
                        <div class="question-card">
                            <div class="title text-center"></div>
                            <div class="question-wrapper">
                                <div class="question-body">
                                    <!--<div class="answer-boxes text-center">
                                    <p class="text-white" style="margin-top: 20px">خیر</p>
                                </div>
                                <div class="time-box ">
                                    <p class="description">
                                        زمان باقی مانده
                                    </p>
                                    <div class="text-center">
                                        <p class="text-white" style="font-size: 100px;text-shadow: 5px 5px 5px #8e8895">
                                            120
                                            <span style="font-size: 20px">ثانیه</span>
                                        </p>
                                    </div>
                                </div> -->
                                </div>
                                <div class="question-body2"></div>
                                <div id="answer-container">
                                </div>
                                <div class="text-center" id="wrongAnswerText">
                                </div>
                                <div id="end-game-box" style="display:none">
                                    <div id="end-game-loading">
                                        <div id="loading" class="text-center">
                                            <div class="lds-ellipsis">
                                                <div></div>
                                                <div></div>
                                                <div></div>
                                                <div></div>
                                            </div>
                                        </div>
                                        <div class="text-center text-white" style="direction:ltr;"
                                            id="end-game-loading-text">اعمال سکه های جایزه لطفا صبر کنید...</div>
                                        <div class="text-center" style="color:greenyellow;" id="end-game-loading-done">
                                            سکه های شما اعمال شد.</div>

                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="coin-box">
                            <p class="coin-text" style="display: inline">جایزه فعلی شما: </p><i class="fas fa-coins"
                                style="color: gold;padding: 10px ;display: inline;direction:rtl;padding: 10px"></i><span
                                id="coin-rewards">0</span>
                        </div>
                    </div>
                    <div class="col-md-3"></div>
                </div>
            </div>
            <!-- second box -->
        </div>
        <script>
            let currentQuestion = undefined, session = undefined;
            $(() =>
            {
                session = JSON.parse(`{{{session_str}}}`);
                // if (session.questions.length != 0)
                // {
                //     $(".intro-card").hide(0);
                //     $(".coin-box").hide(0);
                //     $("#questions #question-box").hide(0);
                //     $("#loading-box").show();
                //     $("#loading-box #loading").hide(0);
                //     $("#loading-box .title").html('Error');
                //     $("#loading-box #loading-text").html('<span style="color:red">reload nakon heyvan :)))))))</span>');

                // }
                if (session.status == 'loose')
                {
                    $("#intro-box").hide(0);
                    // $("#questions").show(0);
                    $("#questions #question-box").hide(0);
                    $("#loading-box").show();
                    $("#loading-box #loading").hide(0);
                    $("#loading-box .title").html('Error');
                    $("#loading-box #loading-text").html('<span style="color:red">ERROR: Session is already lost</span>');
                }
                else
                {
                    if (session.questions.length == 0)
                    {
                        //show intro page:
                        $("#intro-box").show();
                        $("#questions").hide();
                    }
                    else
                    {
                        startQuiz();
                        $("#coin-rewards").html((session.questions.length - 1) * 10);
                        // let hasUnAnsweredQuestion = false;
                        // for (var i = 0; i < session.questions.length; i++)
                        // {
                        //     if (session.questions[i].answer == -1)
                        //     {
                        //         hasUnAnsweredQuestion = true;
                        //         break;
                        //     }
                        // }
                        // if (!hasUnAnsweredQuestion)
                        // {
                        //     startQuiz();
                        // }
                        // else
                        // {
                        //     //resume quiz:
                        //     $("#intro-box").hide(300);
                        //     $("#questions").show(300);
                        //     $("#loading-box").show(0);
                        //     $("#question-box").hide(0);
                        // }
                    }
                }
            });
            function startQuiz()
            {
                $("#intro-box").hide(300);
                $("#questions").show(300);
                $("#loading-box").show(0);
                $("#question-box").hide(0);
                loadQuestion();
            }
            function loadQuestion()
            {
                $("#question-box").show();
                $("#loading-box .title").html('در حال بارگذاری...');
                fetch('/dota2-quiz/get-questions', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: `{{{currentUser._id}}}`,
                        userToken: `{{{currentUser.token}}}`,
                        sessionId: `{{{session._id}}}`,
                        limit: 1,
                        // level : (session.questions.length%5),
                    }),
                }).then((response) => response.json()).then((response) =>
                {
                    $("#loading").hide();
                    $("#loading-text").hide();
                    $("#loading-box").hide();
                    $("#question-box").show(0);
                    $("#question-box .question-body").html('');
                    $("#question-box .question-body2").html('');
                    $("#answer-container").html('');
                    console.log(response);
                    if (response.code != 200)
                    {
                        $("#question-box .title").html('ERROR:' + response.error.toString());
                    }
                    else
                    {
                        response = response._data;
                        let question = response.questions[0];
                        currentQuestion = question;
                        session = response.session;
                        $(".question-card .title").html('');
                        $(".question-card .title").append(`سوال: ${session.questions.length} `);
                        if (question.question2 == undefined)
                            question.question2 = '';
                        //shuffle options:
                        for (var i = 0; i < 20; i++)
                        {
                            let a = parseInt(Math.random() * question.options.length);
                            let b = parseInt(Math.random() * question.options.length);
                            let temp = question.options[a];
                            question.options[a] = question.options[b];
                            question.options[b] = temp;
                        }
                        //render body:
                        let str = '';
                        if (question.question.indexOf('[img') != -1)
                        {
                            let src = question.question.replace('[img]', '').replace('[/img]', '');
                            str = `<div class="text-center"><img align="middle" src="${src}" /></div>`
                        }
                        else if (question.question.indexOf('[audio') != -1)
                        {
                            let src = question.question.replace('[audio]', '').replace('[/audio]', '');
                            str = `<audio controls><source src="${src}" type="audio/mpeg">Your browser does not support the audio element.</audio>`;
                        }
                        else
                        {
                            str = question.question;
                        }
                        $("#question-box .question-card .question-body").html(str);
                        //render body 2:
                        str = '';
                        if (question.question2.indexOf('[img') != -1)
                        {
                            let src = question.question2.replace('[img]', '').replace('[/img]', '');
                            str = `<div class="text-center"><img src="${src}" width="100%" /></div>`
                        }
                        else if (question.question2.indexOf('[audio') != -1)
                        {
                            let src = question.question2.replace('[audio]', '').replace('[/audio]', '');
                            str = `<audio controls><source src="${src}" type="audio/mpeg">Your browser does not support the audio element.</audio>`;
                        }
                        else
                        {
                            str = question.question2;
                        }
                        $("#question-box .question-card .question-body2").html(str);
                        //render options:
                        for (var i = 0; i < question.options.length; i++)
                        {
                            let str = ``;
                            let o = question.options[i];
                            if (o.body.indexOf('[img') != -1)
                            {
                                let src = o.body.replace('[img]', '').replace('[/img]', '');
                                str = `<img src="${src}" width="100%" />`

                            }
                            else if (o.body.indexOf('[audio') != -1)
                            {
                                let src = o.body.replace('[audio]', '').replace('[/audio]', '');
                                str = `<audio controls><source src="${src}" type="audio/mpeg">Your browser does not support the audio element.</audio>`;
                            }
                            else
                            {
                                str = o.body;
                            }
                            $("#answer-container").append(`
                            <div class="answer-boxes text-center" index="${o.index}">
                                        <p class="text-white" style="margin-top: 20px">${str}</p>
                                    </div>
                                `);
                            // <div class="col-md-6">
                            //         <div class="btn btn-md btn-primary option-btn" index="${o.index}" style="display:block;margin-bottom:10px;">${str}</div>
                            //     </div>
                        }
                        //set onclicks:
                        $(".answer-boxes").click(function ()
                        {
                            let index = $(this).attr('index');
                            $(this).addClass('choosen-answer');
                            $(".answer-boxes").click(function () { });
                            $("#loading").show();
                            submitAnswer(index);
                        });
                    }
                }).catch((err) =>
                {
                    $(".question-card").html('ERROR:' + err.toString());
                });
            }
            function submitAnswer(index)
            {
                // alert(index);
                fetch('/dota2-quiz/answer-question', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        userId: `{{{currentUser._id}}}`,
                        userToken: `{{{currentUser.token}}}`,
                        sessionId: `{{{session._id}}}`,
                        questionId: currentQuestion._id,
                        answer: parseInt(index),
                    }),
                }).then((response) => response.json()).then((response) =>
                {
                    console.log('submitAnswer response');
                    console.log(response);
                    if (response.code != 200)
                    {
                        alert('Error Submitting Answer');
                        return;
                    }
                    let data = response._data;

                    if (data.correctAnswer != data.answer)
                    {
                        console.log('wrong answer');
                        $(`.answer-boxes[index=${data.answer}]`).removeClass('choosen-answer').addClass('false-answer');
                        $(`.answer-boxes[index=${data.correctAnswer}]`).removeClass('choosen-answer').addClass('correct-answer');
                        session = data.session;
                        if ($(`.answer-boxes[index=${data.answer}]`))
                        {
                            $("#wrongAnswerText").append(`<h3 class="wrong-answer-error-text" style="color:red">جواب شما اشتباه بود :) <br style=""> فردا مجدداََ تلاش کنید</h3>`);
                            $("#coin-rewards").html((session.questions.length - 1) * 10);
                            $("#end-game-box").show();
                            fetch('/dota2-epic-center/finish-quiz', {
                                method: 'POST',
                                headers: {
                                    'Accept': 'application/json',
                                    'Content-Type': 'application/json'
                                },
                                body: JSON.stringify({
                                    userId : `{{{currentUser._id}}}`,
                                    userToken : `{{{currentUser.token}}}`,
                                    sessionId : session._id,
                                }),
                            })
                                .then((response) => (response.json()))
                                .then((response) =>
                                {
                                    if(response.code != 200)
                                    {
                                        alert(response.error);
                                    }
                                    else
                                    {
                                        $("#end-game-loading").hide();
                                        $("#end-game-loading-text").hide();
                                        $("#end-game-loading-done").show();
                                    }
                                }).catch((err) =>
                                {
                                    alert(err);
                                });
                        }
                    }
                    else
                    {
                        console.log('correct answer');
                        session = data.session;
                        console.log($(`.answer-boxes[index=${data.correctAnswer}]`));
                        $(`.answer-boxes[index=${data.correctAnswer}]`)
                            .removeClass('choosen-answer')
                            .addClass('correct-answer');
                        $("#coin-rewards").html((session.questions.length) * 10);
                        setTimeout(() =>
                        {
                            loadQuestion();
                        }, 500);
                    }
                }).catch((err) =>
                {
                    alert(err.toString());
                });
            }
        </script>
    </section>
    {{{footer}}}
</body>

</html>