<html>

<head>
    {{{head}}}
</head>

<body>
    {{{navbar}}}
    <navfiller></navfiller>
    <div class="container">
        <div class="alert alert-warning">
            <a href="/social/posts/new" class="btn btn-md btn-dark">+New Post</a>
        </div>
        <div class="alert alert-info">Imagine Communties Here</div>
        <div class="row">
            <div class="col-md-8">
                <h4>Posts:</h4>
                {{#posts}}
                <div class="card post-card" style="padding:10px 20px;margin-bottom:10px;" postId="{{_id}}">
                    <div>
                        <img src="{{_user.profileImage}}" style="border-radius:50%;width:48px;height:48px;" />
                        <b>{{_user.username}}</b>
                    </div>
                    <hr />
                    <img src="{{media.0}}" width="100%" />
                    <div>{{{body}}}</div>
                    <hr />
                    <div>
                        <span name="like-count">Likes:{{likes.length}}</span>
                        <div class="btn btn-md btn-info btn-like" liked="{{_isLiked}}" loading="false" postId="{{_id}}">
                            {{#_isLiked}}Un-Like{{/_isLiked}}{{^_isLiked}}Like{{/_isLiked}}</div>
                    </div>
                    <hr />
                    {{#_isMine}}
                    <div>
                        <a href="{{#SITE_URL}}/social/posts/edit/{{_id}}{{/SITE_URL}}" target="_blank"
                            class="btn btn-md btn-info">Edit</a>
                        <a href="{{#SITE_URL}}/social/posts/delete/{{_id}}{{/SITE_URL}}"
                            class="btn btn-md btn-danger">Delete</a>
                    </div>
                    {{/_isMine}}
                </div>
                {{/posts}}
            </div>
            <div class="col-md-4">
                <h4>Recommended HashTags:</h4>
                <h4>Recommended Users:</h4>
            </div>
        </div>
    </div>
    <script>
        $(() =>
        {
            $(".btn-like").click(function ()
            {
                let loading = $(this).attr('loading') == 'true';
                let postId = $(this).attr('postId');
                let liked = $(this).attr('liked') == 'true';
                if (loading)
                    return;
                $(this).html('Loading...');
                fetch('/social/set-post-like/', {
                    method: 'POST',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        _id: postId,
                        like: !liked,
                        userId: `{{{currentUser._id}}}`,
                        userToken: `{{{currentUser.token}}}`,
                    }),
                }).then(response => response.json()).then((response) =>
                {
                    if (response.code != 200)
                    {
                        console.log(response.error);
                        alert(response.error);
                    }
                    else
                    {
                        $(this).attr('loading', false);
                        $(this).attr('liked', !liked);
                        $(this).html(liked ? 'Like' : 'Un-Like');
                        let post = response._data;
                        console.log(post);
                        $(`.post-card[postId=${post._id}] [name=like-count]`).html(post.likes.length);
                    }
                }).catch((err) =>
                {
                    console.log(err);
                    alert(err);
                });
            });
        });
    </script>
    {{{footer}}}
</body>

</html>